let todo_group = new Array();
let doing_group = new Array();

init();

function init() {
	for (let i = 0; i < document.querySelector("#todo").querySelectorAll(
			".move_btn").length; i++) {
		todo_group
				.push({
					btn : document.querySelector("#todo").querySelectorAll(
							".move_btn")[i],
					id : todo_set[i]["id"],
					idx : i,
					type : "TODO"
				});
	}

	for (let i = 0; i < document.querySelector("#doing").querySelectorAll(
			".move_btn").length; i++) {
		doing_group.push({
			btn : document.querySelector("#doing")
					.querySelectorAll(".move_btn")[i],
			id : doing_set[i]["id"],
			idx : i,
			type : "DOING"
		});
	}

	for (let i = 0; i < todo_group.length; i++) {
		todo_group[i]["btn"].addEventListener("click", function() {
			ajax(todo_group[i]["id"], todo_group[i]["type"],
					todo_group[i]["idx"]);
			if (todo_group[i]["type"] === "TODO") {
				todo_group[i]["idx"] = document.querySelector("#doing")
						.querySelectorAll(".move_btn").length;
				todo_group[i]["type"] = "DOING";
			} else {
				todo_group[i]["idx"] = document.querySelector("#done")
						.querySelectorAll(".item").length;
				todo_group[i]["type"] = "DONE";
			}
		}, false);
	}

	for (let i = 0; i < doing_group.length; i++) {
		doing_group[i]["btn"].addEventListener("click", function() {
			ajax(doing_group[i]["id"], doing_group[i]["type"],
					doing_group[i]["idx"]);
			doing_group[i]["idx"] = document.querySelector("#done")
					.querySelectorAll(".move_btn").length;
			doing_group[i]["type"] = "DONE";
		}, false);
	}
}

function moveCard(idx, type) {
	switch (type) {
	case "TODO": {
		document.querySelector("#doing").appendChild(
				document.querySelector("#todo").querySelectorAll(".item")[idx]);

		doing_set.push({
			id : todo_set[idx]["id"],
			type : "DOING"
		});

		todo_set.splice(idx, 1);

		console.log(todo_group);
		console.log(todo_set);
		break;
	}
	case "DOING": {
		document.querySelector("#done")
				.appendChild(
						document.querySelector("#doing").querySelectorAll(
								".item")[idx]);

		document.querySelector("#done").querySelectorAll(".item")[document
				.querySelector("#done").querySelectorAll(".item").length - 1]
				.querySelector(".move_btn").style.display = "none";

		doing_set.splice(idx, 1);

		console.log(todo_group);
		console.log(todo_set);
		break;
	}
	}
}

function ajax(id, type, idx) {
	let xhr = new XMLHttpRequest();
	let params = "id=" + id + "&" + "type=" + type;

	xhr.open("POST", '/Todo/TodoTypeServlet', true);
	xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

	xhr.addEventListener("load", function() {
		if (xhr.responseText === "success") {
			moveCard(idx, type);
		}
	});

	xhr.send(params);
}
