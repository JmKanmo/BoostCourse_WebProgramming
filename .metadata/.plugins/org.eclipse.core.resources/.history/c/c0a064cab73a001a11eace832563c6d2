let xhr = new XMLHttpRequest();
let todo_group = document.querySelector("#todo").querySelectorAll(".move_btn");
let doing_group = document.querySelector("#doing")
		.querySelectorAll(".move_btn");

for (let i = 0; i < todo_group.length; i++) {
	register_event(todo_group, todo_set, i);
}

for (let i = 0; i < doing_group.length; i++) {
	register_event(doing_group, doing_set, i);
}

function register_event(group, set, idx) {
	group[idx].addEventListener("click", function() {
		xhr.abort();
		console.log(group);
		console.log(set);
		console.log(idx);
		ajax(set[idx]["id"], set[idx]["type"], idx);
	}, false);
}

function moveCard(idx, type) {
	switch (type) {
	case "TODO": {
		document.querySelector("#doing").appendChild(
				document.querySelector("#todo").querySelectorAll(".item")[idx]);

		document.querySelector("#todo").removeChild(
				document.querySelector("#todo").childNodes[idx]);

		doing_set.push({
			id : todo_set[idx]["id"],
			type : "DOING"
		});

		todo_set.splice(idx, 1);
		todo_group = document.querySelector("#todo").querySelectorAll(
				".move_btn");
		doing_group = document.querySelector("#doing").querySelectorAll(
				".move_btn");

		for (let i = 0; i < todo_group.length; i++) {
			register_event(todo_group, todo_set, i);
		}

		for (let i = 0; i < doing_group.length; i++) {
			register_event(doing_group, doing_set, i);
		}

		break;
	}
	case "DOING": {
		document.querySelector("#doing").querySelectorAll(".item")[idx]
				.querySelector(".move_btn").style.display = "none";

		document.querySelector("#done")
				.appendChild(
						document.querySelector("#doing").querySelectorAll(
								".item")[idx]);
		break;
	}
	}
}

function ajax(id, type, idx) {
	xhr = new XMLHttpRequest();
	let params = "id=" + id + "&" + "type=" + type;

	xhr.open("POST", '/Todo/TodoTypeServlet', true);
	xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

	xhr.addEventListener("load", function() {
		if (xhr.responseText === "success") {
			moveCard(idx, type);
		}
	});

	xhr.send(params);
}
